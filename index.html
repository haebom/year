<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XSPGND1PG7"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XSPGND1PG7');
  </script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Progress</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#4caf50">
  <link rel="apple-touch-icon" href="./maskable_icon_x192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Life Progress">

<style>
  /* Design System Variables */
  :root {
    /* Colors */
    --primary-color: #007AFF;
    --secondary-color: #5856D6;
    --success-color: #34C759;
    --warning-color: #FF9500;
    --danger-color: #FF3B30;
    --background-color: #F2F2F7;
    --text-color: #1C1C1E;
    --text-secondary: #8E8E93;
    --border-color: #E5E5EA;
    --card-background: #FFFFFF;
    --nav-background: rgba(255, 255, 255, 0.9);

    /* Typography */
    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-md: 17px;
    --font-size-lg: 20px;
    --font-size-xl: 24px;
    --font-size-xxl: 34px;

    /* Spacing */
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;

    /* Border Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-full: 9999px;

    /* Shadows */
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.05);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --primary-color: #0A84FF;
      --secondary-color: #5E5CE6;
      --success-color: #30D158;
      --warning-color: #FF9F0A;
      --danger-color: #FF453A;
      --background-color: #000000;
      --text-color: #FFFFFF;
      --text-secondary: #98989D;
      --border-color: #38383A;
      --card-background: #1C1C1E;
      --nav-background: rgba(28, 28, 30, 0.9);
    }
  }

  /* Reset & Base Styles */
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  /* Layout */
  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: var(--spacing-md);
    padding-bottom: calc(var(--spacing-xl) * 2.5);
  }

  /* Typography */
  h1 {
    font-size: var(--font-size-xxl);
    font-weight: 700;
    margin-bottom: var(--spacing-lg);
    text-align: center;
  }

  h2 {
    font-size: var(--font-size-xl);
    font-weight: 600;
    margin-bottom: var(--spacing-md);
  }

  /* Components */
  .card {
    background: var(--card-background);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin: var(--spacing-md) 0;
    box-shadow: var(--shadow-sm);
  }

  .button {
    width: 100%;
    padding: var(--spacing-md);
    border: none;
    border-radius: var(--radius-md);
    background: var(--card-background);
    color: var(--text-color);
    font-size: var(--font-size-md);
    font-weight: 600;
    margin: var(--spacing-sm) 0;
    cursor: pointer;
    transition: all 0.2s;
  }

  .button.primary {
    background: var(--primary-color);
    color: white;
  }

  .button.secondary {
    background: var(--secondary-color);
    color: white;
  }

  .button.danger {
    background: var(--danger-color);
    color: white;
  }

  .button:active {
    opacity: 0.7;
    transform: scale(0.98);
  }

  /* Form Elements */
  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }

  .form-group label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
  }

  .form-group input,
  .form-group select {
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    background: var(--card-background);
    color: var(--text-color);
    font-size: var(--font-size-md);
    transition: border-color 0.2s;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  /* Clock & Stats */
  .clock-container {
    margin: var(--spacing-lg) 0;
    display: flex;
    justify-content: center;
  }

  .clock {
    width: 200px;
    height: 200px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    position: relative;
    background: var(--card-background);
    box-shadow: var(--shadow-md);
  }

  .age-display {
    text-align: center;
    font-size: var(--font-size-xxl);
    font-weight: 700;
    margin: var(--spacing-lg) 0;
    color: var(--primary-color);
  }

  .stats-container {
    background: var(--card-background);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin: var(--spacing-lg) 0;
    box-shadow: var(--shadow-md);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-md);
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--primary-color);
  }

  .stat-label {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    margin-top: var(--spacing-xs);
  }

  /* Navigation */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--nav-background);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: flex;
    justify-content: space-around;
    padding: var(--spacing-sm) 0;
    border-top: 1px solid var(--border-color);
    box-shadow: var(--shadow-lg);
  }

  .nav-item {
    text-decoration: none;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-sm) var(--spacing-md);
    transition: all 0.2s;
  }

  .nav-item.active {
    color: var(--primary-color);
  }

  /* Modals */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    animation: fadeIn 0.2s ease-out;
  }

  .modal-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card-background);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    padding: var(--spacing-xl);
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease-out;
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  /* Quest Items */
  .quest-item {
    background: var(--card-background);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-sm);
  }

  .quest-item:active {
    transform: scale(0.98);
  }

  /* Notifications */
  .notification-badge {
    position: relative;
    display: inline-flex;
  }

  .notification-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger-color);
    color: white;
    font-size: var(--font-size-xs);
    padding: 2px 6px;
    border-radius: var(--radius-full);
    min-width: 18px;
    text-align: center;
  }

  /* 퀘스트 모달 스타일 */
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
  }

  .close-button {
    background: none;
    border: none;
    font-size: var(--font-size-xl);
    color: var(--text-secondary);
    cursor: pointer;
    padding: var(--spacing-xs);
  }

  .quest-stats-container {
    display: flex;
    justify-content: space-around;
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    background: var(--card-background);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .quest-stat {
    text-align: center;
  }

  .quest-stat-value {
    font-size: var(--font-size-xl);
    font-weight: 600;
    color: var(--primary-color);
  }

  .quest-stat-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-top: var(--spacing-xs);
  }

  .quest-form {
    margin-bottom: var(--spacing-lg);
  }

  .quest-category-select {
    width: 100%;
    margin-bottom: var(--spacing-sm);
  }

  .quest-input-container {
    display: flex;
    gap: var(--spacing-sm);
  }

  .quest-input-container input {
    flex: 1;
  }

  .quest-add-button {
    background: var(--primary-color);
    border: none;
    border-radius: var(--radius-md);
    color: white;
    width: 48px;
    height: 48px;
    padding: var(--spacing-sm);
    cursor: pointer;
    transition: all 0.2s;
  }

  .quest-add-button:active {
    transform: scale(0.95);
  }

  .quest-categories {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    overflow-x: auto;
    padding-bottom: var(--spacing-sm);
    -webkit-overflow-scrolling: touch;
  }

  .category-filter {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-full);
    padding: var(--spacing-sm) var(--spacing-md);
    color: var(--text-color);
    font-size: var(--font-size-sm);
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
  }

  .category-filter.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }

  .quest-list-container {
    max-height: 50vh;
    overflow-y: auto;
    padding: var(--spacing-sm);
  }

  .quest-item {
    display: flex;
    align-items: center;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    background: var(--card-background);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    transition: all 0.2s;
  }

  .quest-item:active {
    transform: scale(0.98);
  }

  .quest-checkbox {
    appearance: none;
    width: 24px;
    height: 24px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-sm);
    margin-right: var(--spacing-md);
    cursor: pointer;
    transition: all 0.2s;
  }

  .quest-checkbox:checked {
    background: var(--primary-color);
    border-color: var(--primary-color);
  }

  .quest-checkbox:checked::after {
    content: '✓';
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: var(--font-size-sm);
  }

  .quest-content {
    flex: 1;
  }

  .quest-title {
    font-size: var(--font-size-md);
    margin-bottom: var(--spacing-xs);
  }

  .quest-category {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
  }

  .quest-actions {
    display: flex;
    gap: var(--spacing-sm);
  }

  .quest-share-button,
  .quest-delete-button {
    background: none;
    border: none;
    padding: var(--spacing-sm);
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s;
  }

  .quest-share-button:hover {
    color: var(--primary-color);
  }

  .quest-delete-button:hover {
    color: var(--danger-color);
  }

  /* 친구 모달 스타일 */
  .friend-stats-container {
    display: flex;
    justify-content: space-around;
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    background: var(--card-background);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .friend-stat {
    text-align: center;
  }

  .friend-stat-value {
    font-size: var(--font-size-xl);
    font-weight: 600;
    color: var(--primary-color);
  }

  .friend-stat-label {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-top: var(--spacing-xs);
  }

  .friend-form {
    margin-bottom: var(--spacing-lg);
  }

  .friend-input-container {
    display: flex;
    gap: var(--spacing-sm);
  }

  .friend-input-container input {
    flex: 1;
  }

  .friend-add-button {
    background: var(--primary-color);
    border: none;
    border-radius: var(--radius-md);
    color: white;
    width: 48px;
    height: 48px;
    padding: var(--spacing-sm);
    cursor: pointer;
    transition: all 0.2s;
  }

  .friend-add-button:active {
    transform: scale(0.95);
  }

  .friend-sections {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .friend-section h3 {
    font-size: var(--font-size-md);
    color: var(--text-secondary);
    margin-bottom: var(--spacing-md);
  }

  .friend-requests-list,
  .friends-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .friend-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md);
    background: var(--card-background);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .friend-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
  }

  .friend-avatar {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    background: var(--secondary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: var(--font-size-sm);
  }

  .friend-details {
    display: flex;
    flex-direction: column;
  }

  .friend-email {
    font-size: var(--font-size-md);
    color: var(--text-color);
  }

  .friend-status {
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
  }

  .friend-actions {
    display: flex;
    gap: var(--spacing-sm);
  }

  .friend-accept-button,
  .friend-reject-button,
  .friend-remove-button {
    background: none;
    border: none;
    padding: var(--spacing-sm);
    cursor: pointer;
    transition: all 0.2s;
  }

  .friend-accept-button {
    color: var(--success-color);
  }

  .friend-reject-button,
  .friend-remove-button {
    color: var(--danger-color);
  }

  .friend-accept-button:hover,
  .friend-reject-button:hover,
  .friend-remove-button:hover {
    transform: scale(1.1);
  }

  /* 퀘스트 모달 스타일 업데이트 */
  .modal-header {
    padding: var(--spacing-md) var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
  }

  .modal-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
  }

  .back-button {
    background: none;
    border: none;
    padding: var(--spacing-xs);
    color: var(--text-color);
    cursor: pointer;
  }

  .manage-button {
    background: none;
    border: none;
    color: var(--primary-color);
    font-size: var(--font-size-md);
    cursor: pointer;
  }

  .quest-list-container {
    padding: var(--spacing-md);
  }

  .quest-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
  }

  .quest-item {
    background: var(--card-background);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
  }

  .quest-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-xs);
  }

  .quest-title {
    font-size: var(--font-size-md);
    font-weight: 500;
    color: var(--text-color);
  }

  .quest-progress {
    font-size: var(--font-size-sm);
    color: var(--text-color);
  }

  .quest-number {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
  }

  .add-quest-button {
    width: 100%;
    padding: var(--spacing-md);
    background: none;
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-lg);
    color: var(--text-secondary);
    font-size: var(--font-size-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    transition: all 0.2s;
  }

  .add-quest-button:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }

  /* 하단 텍스트 추가 */
  .quest-list-container::after {
    content: '기회는 시간이 지날수록 줄어듭니다.';
    display: block;
    text-align: center;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    margin-top: var(--spacing-xl);
    opacity: 0.7;
  }

  /* 퀘스트 추가 모달 스타일 */
  .add-quest-form {
    padding: var(--spacing-lg) var(--spacing-md);
  }

  .count-input {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .count-input input {
    width: 100px;
  }

  .count-label {
    color: var(--text-secondary);
    font-size: var(--font-size-md);
  }

  .deadline-buttons {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
    overflow-x: auto;
    padding-bottom: var(--spacing-xs);
    -webkit-overflow-scrolling: touch;
  }

  .deadline-button {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-full);
    padding: var(--spacing-sm) var(--spacing-md);
    color: var(--text-color);
    font-size: var(--font-size-sm);
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
  }

  .deadline-button.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }

  .custom-deadline {
    width: 100%;
    margin-top: var(--spacing-sm);
  }
</style>
<script>
  // Firebase 구성
  const firebaseConfig = {
    apiKey: "AIzaSyB73bnwE9jTVqiTAvb2BvginUFAgvAcZtw",
    authDomain: "blocks-1b622.firebaseapp.com",
    projectId: "blocks-1b622",
    storageBucket: "blocks-1b622.firebasestorage.app",
    messagingSenderId: "486313931623",
    appId: "1:486313931623:web:2c81258f6c05e2bb8d75c2",
    measurementId: "G-QZH0VBXH25"
  };

  // Firebase 초기화
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const messaging = firebase.messaging();

  // FCM 설정
  messaging.getToken({
    vapidKey: 'BP4wdRA9DJ899-SilAiy_Qiu_idCev8FpbgYnALT7_n-XjfxLnjAHSXvYraMVRoK4dN09b55Abd-AV4X_zO3jrI' // Firebase 콘솔에서 생성한 키를 여기에 입력
  }).then((currentToken) => {
    if (currentToken) {
      // 토큰이 생성되면 서버에 저장
      if (firebase.auth().currentUser) {
        db.collection('users').doc(firebase.auth().currentUser.uid).update({
          fcmToken: currentToken
        });
      }
    } else {
      console.log('토큰을 생성할 수 없습니다.');
    }
  }).catch((err) => {
    console.log('토큰 생성 중 에러 발생:', err);
  });

  // 포그라운드 메시지 처리
  messaging.onMessage((payload) => {
    console.log('메시지 수신:', payload);
    // 알림 표시
    new Notification(payload.notification.title, {
      body: payload.notification.body,
      icon: '/maskable_icon_x192.png'
    });
  });

  document.addEventListener('DOMContentLoaded', function() {
    const auth = firebase.auth();
    const userInfo = document.querySelector('.user-info');
    const questContainer = document.querySelector('.quest-container');
    const questList = document.querySelector('.quest-list');
    const lifeExpectancyContainer = document.querySelector('.life-expectancy-container');
    const friendContainer = document.querySelector('.friend-container');
    
    // 사용자 데이터 로드
    async function loadUserData(userId) {
      const userRef = db.collection('users').doc(userId);
      const doc = await userRef.get();
      
      if (doc.exists) {
        const userData = doc.data();
        if (userData.birthYear) {
          document.getElementById('birthYear').value = userData.birthYear;
          document.getElementById('lifeExpectancy').value = userData.lifeExpectancy || 80;
          updateLifeProgress();
        }
      }
    }

    // 인증 상태 관찰자 수정
    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById('loginButton').style.display = 'none';
        document.getElementById('logoutButton').style.display = 'inline-block';
        userInfo.style.display = 'block';
        questContainer.style.display = 'block';
        lifeExpectancyContainer.style.display = 'block';
        friendContainer.style.display = 'block';
        userInfo.textContent = `환영합니다, ${user.email}님!`;
        
        // 사용자 정보 저장
        db.collection('users').doc(user.uid).set({
          email: user.email
        }, { merge: true });

        loadUserData(user.uid);
        loadQuests(user.uid);
        updateQuestStats(user.uid);
        loadFriends(user.uid);
        loadSharedQuests(user.uid);
        requestNotificationPermission();
        loadNotifications();
        checkInitialSetup(user.uid);
      } else {
        document.getElementById('loginButton').style.display = 'inline-block';
        document.getElementById('logoutButton').style.display = 'none';
        userInfo.style.display = 'none';
        questContainer.style.display = 'none';
        lifeExpectancyContainer.style.display = 'none';
        friendContainer.style.display = 'none';
        questList.innerHTML = '';
      }
    });

    // 생년월일과 기대수명 저장
    window.saveLifeExpectancy = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const birthYear = parseInt(document.getElementById('birthYear').value);
      const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);

      try {
        await db.collection('users').doc(user.uid).set({
          birthYear: birthYear,
          lifeExpectancy: lifeExpectancy
        }, { merge: true });
        
        updateLifeProgress();
      } catch (error) {
        console.error("설정 저장 에러:", error);
        alert("설정 저장 중 오류가 발생했습니다.");
      }
    };

    // 인생 진행률 업데이트
    function updateLifeProgress() {
      const birthYear = parseInt(document.getElementById('birthYear').value);
      const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);
      const currentYear = new Date().getFullYear();
      
      const age = currentYear - birthYear;
      const progress = (age / lifeExpectancy) * 100;
      
      const lifeProgressBar = document.querySelector('.life-progress-bar');
      lifeProgressBar.style.width = `${Math.min(progress, 100)}%`;
      
      document.querySelector('.life-progress-text').textContent = 
        `당신의 인생 ${progress.toFixed(1)}% 진행됨 (${age}세)`;
    }

    // 퀘스트 통계 업데이트
    async function updateQuestStats(userId) {
      const questsRef = db.collection('users').doc(userId).collection('quests');
      const snapshot = await questsRef.get();
      
      let total = 0;
      let completed = 0;
      const categoryStats = {};
      
      snapshot.forEach(doc => {
        const quest = doc.data();
        total++;
        if (quest.completed) completed++;
        
        const category = quest.category || '미분류';
        categoryStats[category] = categoryStats[category] || { total: 0, completed: 0 };
        categoryStats[category].total++;
        if (quest.completed) categoryStats[category].completed++;
      });
      
      document.querySelector('.total-quests').textContent = total;
      document.querySelector('.completed-quests').textContent = completed;
      document.querySelector('.completion-rate').textContent = 
        total > 0 ? `${((completed/total) * 100).toFixed(1)}%` : '0%';
      
      // 카테고리별 통계 업데이트
      const statsContainer = document.querySelector('.category-stats');
      statsContainer.innerHTML = '';
      
      Object.entries(categoryStats).forEach(([category, stats]) => {
        const div = document.createElement('div');
        div.className = 'quest-category';
        div.innerHTML = `
          <h3>${category}</h3>
          <p>완료: ${stats.completed}/${stats.total} (${((stats.completed/stats.total) * 100).toFixed(1)}%)</p>
        `;
        statsContainer.appendChild(div);
      });
    }

    // 퀘스트 로드
    async function loadQuests(userId) {
      const questsRef = db.collection('users').doc(userId).collection('quests');
      const snapshot = await questsRef.get();
      
      questList.innerHTML = '';
      snapshot.forEach(doc => {
        const quest = doc.data();
        addQuestToList(doc.id, quest.title, quest.completed);
      });
    }

    // 퀘스트 추가
    window.addQuest = async (event) => {
      event.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const questInput = document.getElementById('questInput');
      const questTitle = questInput.value.trim();
      const category = document.getElementById('questCategory').value;
      
      if (questTitle) {
        const questData = {
          title: questTitle,
          category: category,
          completed: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
          const docRef = await db.collection('users').doc(user.uid)
            .collection('quests').add(questData);
          addQuestToList(docRef.id, questTitle, false, category);
          questInput.value = '';
          updateQuestStats(user.uid);
        } catch (error) {
          console.error("퀘스트 추가 에러:", error);
          alert("퀘스트 추가 중 오류가 발생했습니다.");
        }
      }
    };

    // 퀘스트 삭제
    window.deleteQuest = async (questId) => {
      const user = auth.currentUser;
      if (!user) return;

      try {
        await db.collection('users').doc(user.uid)
          .collection('quests').doc(questId).delete();
        document.getElementById(`quest-${questId}`).remove();
      } catch (error) {
        console.error("퀘스트 삭제 에러:", error);
        alert("퀘스트 삭제 중 오류가 발생했습니다.");
      }
    };

    // 퀘스트 완료 상태 토글
    window.toggleQuest = async (questId) => {
      const user = auth.currentUser;
      if (!user) return;

      const questRef = db.collection('users').doc(user.uid)
        .collection('quests').doc(questId);
      
      try {
        const doc = await questRef.get();
        const newStatus = !doc.data().completed;
        await questRef.update({ completed: newStatus });
        
        const checkbox = document.querySelector(`#quest-${questId} input[type="checkbox"]`);
        checkbox.checked = newStatus;
      } catch (error) {
        console.error("퀘스트 상태 변경 에러:", error);
        alert("퀘스트 상태 변경 중 오류가 발생했습니다.");
      }
    };

    // 퀘스트 UI에 추가
    function addQuestToList(id, title, completed, category, shared = false, sharedBy = null) {
      const li = document.createElement('li');
      li.id = `quest-${id}`;
      li.className = 'quest-item';
      li.dataset.category = category;
      
      li.innerHTML = `
        <input type="checkbox" class="quest-checkbox" ${completed ? 'checked' : ''} 
          onchange="toggleQuest('${id}')">
        <div class="quest-content">
          <div class="quest-title">${title}</div>
          <div class="quest-category">${category}</div>
          ${shared ? `<div class="shared-by">공유: ${sharedBy}</div>` : ''}
        </div>
        <div class="quest-actions">
          ${!shared ? `
            <button onclick="shareQuest('${id}')" class="quest-share-button">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                <polyline points="16 6 12 2 8 6"></polyline>
                <line x1="12" y1="2" x2="12" y2="15"></line>
              </svg>
            </button>
          ` : ''}
          <button onclick="deleteQuest('${id}')" class="quest-delete-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      `;
      
      document.querySelector('.quest-list').appendChild(li);
    }

    // 구글 로그인 처리
    window.googleLogin = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch((error) => {
          console.error("로그인 에러:", error);
          alert("로그인 중 오류가 발생했습니다.");
        });
    };

    // 로그아웃 처리
    window.logout = () => {
      auth.signOut()
        .catch((error) => {
          console.error("로그아웃 에러:", error);
          alert("로그아웃 중 오류가 발생했습니다.");
        });
    };

    const updateProgress = () => {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 1);
      const end = new Date(now.getFullYear() + 1, 0, 1);
      const progress = (now - start) / (end - start);
      const progressBar = document.querySelector('.progress-bar');
      progressBar.style.width = (progress * 100).toFixed(5) + '%';
      document.querySelector('.progress-text').textContent = 
        `${now.getFullYear()}년이 ${(progress * 100).toFixed(5)}% 지났습니다.`;
    };

    setInterval(updateProgress, 1000);
    updateProgress();

    // 친구 관련 함수들
    async function loadFriends(userId) {
      const friendsRef = db.collection('users').doc(userId).collection('friends');
      const pendingRef = db.collection('users').doc(userId).collection('pendingFriends');
      
      const [friendsSnapshot, pendingSnapshot] = await Promise.all([
        friendsRef.get(),
        pendingRef.get()
      ]);

      const requestsList = document.querySelector('.friend-requests-list');
      const friendsList = document.querySelector('.friends-list');
      
      requestsList.innerHTML = '';
      friendsList.innerHTML = '';

      // 통계 업데이트
      document.getElementById('totalFriends').textContent = friendsSnapshot.size;
      document.getElementById('pendingRequests').textContent = pendingSnapshot.size;

      // 친구 요청 표시
      pendingSnapshot.forEach(doc => {
        const friendData = { id: doc.id, ...doc.data() };
        requestsList.appendChild(updateFriendUI(friendData, 'request'));
      });

      // 친구 목록 표시
      friendsSnapshot.forEach(doc => {
        const friendData = { id: doc.id, ...doc.data() };
        friendsList.appendChild(updateFriendUI(friendData));
      });
    }

    // 친구 추가 요청
    window.addFriend = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const friendEmail = document.getElementById('friendEmail').value.trim();
      if (!friendEmail) return;

      try {
        // 자기 자신을 친구로 추가하는 것을 방지
        if (friendEmail === user.email) {
          alert("자기 자신을 친구로 추가할 수 없습니다.");
          return;
        }

        // 이메일로 사용자 검색
        const usersRef = db.collection('users');
        const snapshot = await usersRef.where('email', '==', friendEmail).get();

        if (snapshot.empty) {
          alert("해당 이메일의 사용자를 찾을 수 없습니다.");
          return;
        }

        const friendDoc = snapshot.docs[0];
        const friendId = friendDoc.id;

        // 이미 친구인지 확인
        const existingFriend = await db.collection('users').doc(user.uid)
          .collection('friends').where('email', '==', friendEmail).get();
        
        if (!existingFriend.empty) {
          alert("이미 친구로 등록된 사용자입니다.");
          return;
        }

        // 친구 요청이 이미 존재하는지 확인
        const existingRequest = await db.collection('users').doc(friendId)
          .collection('pendingFriends').where('email', '==', user.email).get();
        
        if (!existingRequest.empty) {
          alert("이미 친구 요청을 보냈습니다.");
          return;
        }

        // 상대방의 pendingFriends에 추가
        await db.collection('users').doc(friendId).collection('pendingFriends').add({
          email: user.email,
          uid: user.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('friendEmail').value = '';
        alert("친구 요청을 보냈습니다.");
      } catch (error) {
        console.error("친구 추가 에러:", error);
        alert("친구 추가 중 오류가 발생했습니다.");
      }
    };

    // 친구 요청 수락
    window.acceptFriend = async (requestId) => {
      const user = auth.currentUser;
      if (!user) return;

      try {
        // 요청 정보 가져오기
        const requestRef = db.collection('users').doc(user.uid)
          .collection('pendingFriends').doc(requestId);
        const request = await requestRef.get();
        const requestData = request.data();

        // 양쪽 모두 friends 컬렉션에 추가
        await db.collection('users').doc(user.uid).collection('friends').add({
          email: requestData.email,
          uid: requestData.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        await db.collection('users').doc(requestData.uid).collection('friends').add({
          email: user.email,
          uid: user.uid,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // pendingFriends에서 요청 삭제
        await requestRef.delete();

        // 친구 목록 새로고침
        loadFriends(user.uid);
      } catch (error) {
        console.error("친구 수락 에러:", error);
        alert("친구 수락 중 오류가 발생했습니다.");
      }
    };

    // 친구 요청 거절
    window.rejectFriend = async (requestId) => {
      const user = auth.currentUser;
      if (!user) return;

      try {
        // pendingFriends에서 요청 삭제
        await db.collection('users').doc(user.uid)
          .collection('pendingFriends').doc(requestId).delete();

        // 친구 목록 새로고침
        loadFriends(user.uid);
      } catch (error) {
        console.error("친구 거절 에러:", error);
        alert("친구 거절 중 오류가 발생했습니다.");
      }
    };

    // 친구 삭제
    window.removeFriend = async (friendId) => {
      const user = auth.currentUser;
      if (!user) return;

      if (!confirm("정말 이 친구를 삭제하시겠습니까?")) return;

      try {
        const friendRef = db.collection('users').doc(user.uid)
          .collection('friends').doc(friendId);
        const friendDoc = await friendRef.get();
        const friendData = friendDoc.data();

        // 양쪽 모두에서 친구 관계 삭제
        await friendRef.delete();

        // 상대방의 친구 목록에서도 삭제
        const otherFriendRef = db.collection('users').doc(friendData.uid)
          .collection('friends');
        const otherFriendSnapshot = await otherFriendRef.where('email', '==', user.email).get();
        
        otherFriendSnapshot.forEach(async (doc) => {
          await doc.ref.delete();
        });

        // 친구 목록 새로고침
        loadFriends(user.uid);
      } catch (error) {
        console.error("친구 삭제 에러:", error);
        alert("친구 삭제 중 오류가 발생했습니다.");
      }
    };

    // 퀘스트 공유
    window.shareQuest = async (questId) => {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const questRef = db.collection('users').doc(user.uid)
          .collection('quests').doc(questId);
        const questDoc = await questRef.get();
        const questData = questDoc.data();

        // 친구 목록 가져오기
        const friendsRef = db.collection('users').doc(user.uid).collection('friends');
        const friendsSnapshot = await friendsRef.get();

        // 각 친구에게 퀘스트 공유
        friendsSnapshot.forEach(async (friendDoc) => {
          const friendData = friendDoc.data();
          await db.collection('users').doc(friendData.uid)
            .collection('sharedQuests').add({
              title: questData.title,
              category: questData.category,
              completed: questData.completed,
              sharedBy: user.email,
              originalQuestId: questId,
              originalUserId: user.uid,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        });

        alert("퀘스트가 친구들과 공유되었습니다!");
      } catch (error) {
        console.error("퀘스트 공유 에러:", error);
        alert("퀘스트 공유 중 오류가 발생했습니다.");
      }
    };

    // 공유된 퀘스트 로드
    async function loadSharedQuests(userId) {
      const sharedQuestsRef = db.collection('users').doc(userId).collection('sharedQuests');
      const snapshot = await sharedQuestsRef.get();
      
      const sharedQuestsContainer = document.createElement('div');
      sharedQuestsContainer.className = 'friend-quest-container';
      sharedQuestsContainer.innerHTML = '<h3>친구의 퀘스트</h3>';
      
      snapshot.forEach(doc => {
        const questData = doc.data();
        const questElement = document.createElement('div');
        questElement.className = 'quest-item shared-quest';
        questElement.innerHTML = `
          <div class="friend-quest-header">
            <div>
              <span>${questData.title}</span>
              <div class="shared-by">by ${questData.sharedBy}</div>
            </div>
            <div>
              <button onclick="cheerQuest('${doc.id}', '${questData.originalUserId}')" class="cheer-button">
                응원하기 <span class="cheer-count">${questData.cheers || 0}</span>
              </button>
            </div>
          </div>
        `;
        sharedQuestsContainer.appendChild(questElement);
      });

      // 기존 공유 퀘스트 컨테이너가 있다면 제거
      const existingContainer = document.querySelector('.friend-quest-container');
      if (existingContainer) {
        existingContainer.remove();
      }

      // 새로운 컨테이너 추가
      questContainer.appendChild(sharedQuestsContainer);
    }

    // 퀘스트 응원하기
    window.cheerQuest = async (questId, originalUserId) => {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const questRef = db.collection('users').doc(user.uid)
          .collection('sharedQuests').doc(questId);
        
        await questRef.update({
          cheers: firebase.firestore.FieldValue.increment(1)
        });

        // 원본 퀘스트 작성자에게 알림
        await db.collection('users').doc(originalUserId)
          .collection('notifications').add({
            type: 'cheer',
            from: user.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

        // UI 업데이트
        const cheerCount = document.querySelector(`#quest-${questId} .cheer-count`);
        if (cheerCount) {
          cheerCount.textContent = parseInt(cheerCount.textContent) + 1;
        }
      } catch (error) {
        console.error("응원하기 에러:", error);
        alert("응원하기 중 오류가 발생했습니다.");
      }
    };

    // PWA 등록
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('ServiceWorker 등록 성공:', registration.scope);
          })
          .catch(err => {
            console.log('ServiceWorker 등록 실패:', err);
          });
      });
    }

    // Firebase 메시징 설정
    const messaging = firebase.messaging();
    
    // 알림 권한 요청
    async function requestNotificationPermission() {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          const token = await messaging.getToken();
          // 토큰을 서버에 저장
          const user = auth.currentUser;
          if (user) {
            await db.collection('users').doc(user.uid).update({
              notificationToken: token
            });
          }
        }
      } catch (error) {
        console.error('알림 권한 요청 실패:', error);
      }
    }

    // 설치 프롬프트 처리
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.querySelector('.install-prompt').style.display = 'block';
    });

    function installPWA() {
      document.querySelector('.install-prompt').style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('사용자가 설치를 수락했습니다.');
        }
        deferredPrompt = null;
      });
    }

    function dismissInstallPrompt() {
      document.querySelector('.install-prompt').style.display = 'none';
    }

    // 알림 관련 함수들
    let notifications = [];
    
    function toggleNotifications() {
      const panel = document.querySelector('.notification-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function loadNotifications() {
      const user = auth.currentUser;
      if (!user) return;

      const notificationsRef = db.collection('users').doc(user.uid)
        .collection('notifications')
        .orderBy('timestamp', 'desc')
        .limit(20);

      const snapshot = await notificationsRef.get();
      notifications = [];
      const notificationList = document.querySelector('.notification-list');
      notificationList.innerHTML = '';

      snapshot.forEach(doc => {
        const notification = doc.data();
        notifications.push({
          id: doc.id,
          ...notification
        });

        const div = document.createElement('div');
        div.className = `notification-item ${notification.read ? '' : 'unread'}`;
        div.onclick = () => markNotificationAsRead(doc.id);
        
        let message = '';
        switch(notification.type) {
          case 'cheer':
            message = `${notification.from}님이 회원님의 퀘스트를 응원했습니다!`;
            break;
          case 'friend_request':
            message = `${notification.from}님이 친구 요청을 보냈습니다.`;
            break;
          case 'quest_complete':
            message = `${notification.questTitle} 퀘스트를 완료했습니다!`;
            break;
        }

        div.innerHTML = `
          <div>${message}</div>
          <small>${new Date(notification.timestamp.toDate()).toLocaleString()}</small>
        `;
        notificationList.appendChild(div);
      });

      updateNotificationBadge();
    }

    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = document.querySelector('.notification-count');
      badge.textContent = unreadCount;
      badge.style.display = unreadCount > 0 ? 'block' : 'none';
    }

    async function markNotificationAsRead(notificationId) {
      const user = auth.currentUser;
      if (!user) return;

      await db.collection('users').doc(user.uid)
        .collection('notifications')
        .doc(notificationId)
        .update({
          read: true
        });

      const notification = notifications.find(n => n.id === notificationId);
      if (notification) {
        notification.read = true;
      }

      document.querySelector(`[data-notification-id="${notificationId}"]`)
        ?.classList.remove('unread');
      
      updateNotificationBadge();
    }

    // Firebase 메시징 포그라운드 핸들러
    messaging.onMessage((payload) => {
      const notification = payload.notification;
      new Notification(notification.title, {
        body: notification.body,
        icon: '/icons/icon-192x192.png'
      });
      loadNotifications();
    });

    // 시계 및 나이 계산 관련 변수
    const birthDate = new Date('1987-06-15'); // 사용자의 생년월일
    const lifeExpectancy = 80; // 기대수명
    let clockInterval;

    // DOM 요소
    const hourHand = document.querySelector('.hour-hand');
    const minuteHand = document.querySelector('.minute-hand');
    const secondHand = document.querySelector('.second-hand');
    const ageDisplay = document.querySelector('.age-display .years');
    const statValues = document.querySelectorAll('.stat-value');

    // 시계 업데이트 함수
    function updateClock() {
      const now = new Date();
      const age = (now - birthDate) / (1000 * 60 * 60 * 24 * 365.25);
      const progress = age / lifeExpectancy;

      // 시계 바늘 회전
      const seconds = progress * 60;
      const minutes = seconds / 60;
      const hours = minutes / 12;

      secondHand.style.transform = `rotate(${seconds * 6}deg)`;
      minuteHand.style.transform = `rotate(${minutes * 6}deg)`;
      hourHand.style.transform = `rotate(${hours * 30}deg)`;

      // 나이 표시 업데이트
      ageDisplay.textContent = age.toFixed(8);

      // 통계 업데이트
      updateStats(now);
    }

    // 통계 업데이트 함수
    function updateStats(now) {
      const years = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24 * 365.25));
      const seasons = Math.floor(years * 4);
      const weekends = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24 * 7));
      const months = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24 * 30.44));
      const days = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24));
      const hours = Math.floor((now - birthDate) / (1000 * 60 * 60));

      const stats = [years, seasons, weekends, months, days, hours];
      statValues.forEach((value, index) => {
        value.textContent = stats[index].toLocaleString();
      });
    }

    // 모달 관련 함수
    function showModal(modalClass) {
      document.querySelector(`.${modalClass}`).style.display = 'block';
    }

    function hideModal(modalClass) {
      document.querySelector(`.${modalClass}`).style.display = 'none';
    }

    // 초기화 함수
    function init() {
      // 시계 시작
      updateClock();
      clockInterval = setInterval(updateClock, 1000);

      // 모달 닫기 이벤트
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      });

      // Firebase 인증 상태 관찰자 설정
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          // 로그인 상태일 때의 처리
          console.log('User is signed in');
        } else {
          // 로그아웃 상태일 때의 처리
          console.log('No user is signed in');
        }
      });
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', init);

    // 초기 설정 확인 함수
    async function checkInitialSetup(userId) {
      const userDoc = await db.collection('users').doc(userId).get();
      const userData = userDoc.data();
      
      if (!userData.birthYear || !userData.lifeExpectancy) {
        showModal('initial-setup-modal');
      }
    }

    // 초기 설정 폼 제출 처리
    document.getElementById('initialSetupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const user = auth.currentUser;
      if (!user) return;

      const birthYear = parseInt(document.getElementById('initialBirthYear').value);
      const lifeExpectancy = parseInt(document.getElementById('initialLifeExpectancy').value);

      try {
        await db.collection('users').doc(user.uid).update({
          birthYear: birthYear,
          lifeExpectancy: lifeExpectancy,
          setupCompleted: true
        });

        hideModal('initial-setup-modal');
        
        // 시계와 통계 업데이트를 위한 전역 변수 업데이트
        window.birthDate = new Date(birthYear, 0, 1);
        window.lifeExpectancy = lifeExpectancy;
        
        // UI 업데이트
        updateClock();
      } catch (error) {
        console.error("초기 설정 저장 에러:", error);
        alert("설정 저장 중 오류가 발생했습니다.");
      }
    });

    // 퀘스트 필터링 기능
    document.querySelectorAll('.category-filter').forEach(button => {
      button.addEventListener('click', () => {
        // 활성 버튼 스타일 변경
        document.querySelector('.category-filter.active').classList.remove('active');
        button.classList.add('active');

        // 퀘스트 필터링
        const category = button.dataset.category;
        const quests = document.querySelectorAll('.quest-item');
        quests.forEach(quest => {
          if (category === 'all' || quest.dataset.category === category) {
            quest.style.display = 'flex';
          } else {
            quest.style.display = 'none';
          }
        });
      });
    });

    // 친구 목록 UI 업데이트 함수
    function updateFriendUI(friendData, type = 'friend') {
      const container = document.createElement('div');
      container.className = 'friend-item';
      
      const initial = friendData.email.charAt(0).toUpperCase();
      
      container.innerHTML = `
        <div class="friend-info">
          <div class="friend-avatar">${initial}</div>
          <div class="friend-details">
            <div class="friend-email">${friendData.email}</div>
            ${type === 'request' ? '<div class="friend-status">친구 요청</div>' : ''}
          </div>
        </div>
        <div class="friend-actions">
          ${type === 'request' ? `
            <button class="friend-accept-button" onclick="acceptFriend('${friendData.id}')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </button>
            <button class="friend-reject-button" onclick="rejectFriend('${friendData.id}')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          ` : `
            <button class="friend-remove-button" onclick="removeFriend('${friendData.id}')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"></path>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          `}
        </div>
      `;
      
      return container;
    }

    // 퀘스트 추가 모달 표시 함수
    function showAddQuestModal() {
      showModal('add-quest-modal');
    }

    // 기한 버튼 이벤트 처리
    document.querySelectorAll('.deadline-button').forEach(button => {
      button.addEventListener('click', () => {
        // 활성 버튼 스타일 변경
        document.querySelector('.deadline-button.active')?.classList.remove('active');
        button.classList.add('active');

        // 직접 입력 필드 표시/숨김
        const customDeadline = document.getElementById('customDeadline');
        customDeadline.style.display = button.dataset.value === 'custom' ? 'block' : 'none';
      });
    });

    // 퀘스트 추가 폼 제출 처리
    document.getElementById('addQuestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const user = auth.currentUser;
      if (!user) return;

      const title = document.getElementById('newQuestTitle').value;
      const count = parseInt(document.getElementById('newQuestCount').value);
      const activeDeadline = document.querySelector('.deadline-button.active');
      let deadline;

      if (activeDeadline.dataset.value === 'custom') {
        deadline = new Date(document.getElementById('customDeadline').value);
      } else {
        deadline = new Date(parseInt(activeDeadline.dataset.value), 11, 31); // 해당 연도의 마지막 날
      }

      try {
        const questRef = await db.collection('users').doc(user.uid).collection('quests').add({
          title: title,
          targetCount: count,
          currentCount: 0,
          deadline: firebase.firestore.Timestamp.fromDate(deadline),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        hideModal('add-quest-modal');
        
        // 퀘스트 목록 새로고침
        loadQuests(user.uid);
        
        // 폼 초기화
        e.target.reset();
      } catch (error) {
        console.error("퀘스트 추가 에러:", error);
        alert("퀘스트 추가 중 오류가 발생했습니다.");
      }
    });
  });
</script>
</head>
<body>
  <div class="container">
    <h1>내 인생시간</h1>
    
    <div class="clock-container">
      <div class="clock">
        <div class="clock-hand hour-hand"></div>
        <div class="clock-hand minute-hand"></div>
        <div class="clock-hand second-hand"></div>
    </div>
    </div>

    <div class="age-display">
      <span class="years">36.50422732</span> 세
    </div>

    <div class="stats-container">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">36</div>
          <div class="stat-label">생일</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">146</div>
          <div class="stat-label">계절</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">1903</div>
          <div class="stat-label">주말</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">444</div>
          <div class="stat-label">개월</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">13324</div>
          <div class="stat-label">일</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">319753</div>
          <div class="stat-label">시간</div>
        </div>
      </div>
    </div>

    <button class="action-button">목표 기록</button>
    <button class="action-button primary">현재 순간 기록</button>

    <nav class="bottom-nav">
      <a href="#" class="nav-item active">
        <span>인생시간</span>
      </a>
      <a href="#" class="nav-item">
        <span>기록관리</span>
      </a>
      <a href="#" class="nav-item">
        <span>내정보</span>
      </a>
    </nav>

    <!-- 기존 컨테이너들은 모달로 전환 -->
    <div class="modal auth-modal">
      <div class="modal-content">
        <div class="auth-container">
          <!-- 기존 auth 컨텐츠 -->
        </div>
      </div>
    </div>

    <div class="modal quest-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">
            <button class="back-button" onclick="hideModal('quest-modal')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            <h2>2025년 목표(기회)</h2>
          </div>
          <button class="manage-button">관리</button>
        </div>

        <div class="quest-list-container">
          <div class="quest-list">
            <!-- 퀘스트 아이템 예시 -->
            <div class="quest-item">
              <div class="quest-main">
                <div class="quest-title">가족이랑 외식하기</div>
                <div class="quest-progress">0/15</div>
              </div>
              <div class="quest-number">14.99985</div>
            </div>

            <div class="quest-item">
              <div class="quest-main">
                <div class="quest-title">책 1권 읽기</div>
                <div class="quest-progress">0/15</div>
              </div>
              <div class="quest-number">14.99996</div>
            </div>

            <div class="quest-item">
              <div class="quest-main">
                <div class="quest-title">운동</div>
                <div class="quest-progress">0/200</div>
              </div>
              <div class="quest-number">199.9986</div>
            </div>
          </div>

          <button class="add-quest-button" onclick="showAddQuestModal()">
            <span>새로운 목표 추가</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="modal initial-setup-modal">
      <div class="modal-content">
        <h2>환영합니다!</h2>
        <p>더 나은 경험을 위해 몇 가지 정보가 필요합니다.</p>
        <form id="initialSetupForm" class="setup-form">
          <div class="form-group">
            <label for="initialBirthYear">출생연도</label>
            <input type="number" id="initialBirthYear" required min="1900" max="2024" />
          </div>
          <div class="form-group">
            <label for="initialLifeExpectancy">기대수명 (년)</label>
            <input type="number" id="initialLifeExpectancy" required min="1" max="150" value="80" />
          </div>
          <button type="submit" class="action-button primary">시작하기</button>
        </form>
      </div>
    </div>

    <!-- 친구 모달 추가 -->
    <div class="modal friend-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>친구 관리</h2>
          <button class="close-button" onclick="hideModal('friend-modal')">&times;</button>
        </div>

        <div class="friend-stats-container">
          <div class="friend-stat">
            <div class="friend-stat-value" id="totalFriends">0</div>
            <div class="friend-stat-label">전체 친구</div>
          </div>
          <div class="friend-stat">
            <div class="friend-stat-value" id="pendingRequests">0</div>
            <div class="friend-stat-label">대기 중</div>
          </div>
        </div>

        <form class="friend-form" onsubmit="addFriend(event)">
          <div class="form-group">
            <div class="friend-input-container">
              <input type="email" id="friendEmail" placeholder="친구의 이메일을 입력하세요" required>
              <button type="submit" class="friend-add-button">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <line x1="19" y1="8" x2="19" y2="14"></line>
                  <line x1="16" y1="11" x2="22" y2="11"></line>
                </svg>
              </button>
            </div>
          </div>
        </form>

        <div class="friend-sections">
          <div class="friend-section">
            <h3>친구 요청</h3>
            <div class="friend-requests-list"></div>
          </div>

          <div class="friend-section">
            <h3>내 친구</h3>
            <div class="friends-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 퀘스트 추가 모달 -->
    <div class="modal add-quest-modal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">
            <button class="back-button" onclick="hideModal('add-quest-modal')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            <h2>새로운 목표</h2>
          </div>
        </div>

        <form id="addQuestForm" class="add-quest-form">
          <div class="form-group">
            <label>목표</label>
            <input type="text" id="newQuestTitle" placeholder="목표를 입력하세요" required>
          </div>

          <div class="form-group">
            <label>횟수</label>
            <div class="count-input">
              <input type="number" id="newQuestCount" value="15" min="1" max="999" required>
              <span class="count-label">번</span>
            </div>
          </div>

          <div class="form-group">
            <label>기한</label>
            <div class="deadline-buttons">
              <button type="button" class="deadline-button active" data-value="2025">2025년까지</button>
              <button type="button" class="deadline-button" data-value="2024">2024년까지</button>
              <button type="button" class="deadline-button" data-value="custom">직접 입력</button>
            </div>
            <input type="date" id="customDeadline" class="custom-deadline" style="display: none;">
          </div>

          <button type="submit" class="action-button primary">목표 추가하기</button>
        </form>
      </div>
    </div>
  </div>
</body>
</html>
